#!/bin/sh

set -e

basedir=/var/lib/libvirt

ram=1024
cpus=2
storage=ssd
disk=16
graphics=vnc,password=abc
blocking="--wait -1"
os=debian

while getopts ":r:c:md:htWo:" opt; do
        case $opt in
                r ) ram=$OPTARG;;
                c ) cpus=$OPTARG;;
                m ) storage=magnetic;;
                d ) disk=$OPTARG;;
                h ) graphics=none;;
                t ) tty=console=ttyS0,115200;;
                W ) blocking="";;
                o ) os=$OPTARG;;
                : ) echo "-$OPTARG requires an argument" >&2; exit 1;;
                \?) echo "Invalid option: -$OPTARG" >&2; exit 1;;
        esac
done

shift $(($OPTIND - 1))

name=$1

if [ "$os" == "debian" ]; then
	iso=debian-9.8.0-amd64-netinst.iso
	osvar=debian9
	cfg=preseed.cfg
	cfgarg=auto=true
elif [ "$os" == "centos" ]; then
	iso=CentOS-7-x86_64-Minimal-1810.iso
	osvar=centos7.0
	cfg=ks.cfg
	cfgarg=ks=file:/ks.cfg
else
	echo "Invalid OS: '$os'. Valid options: debian, centos"
	exit 1
fi

tempdir=$(mktemp -d)
trap "rm -rf $tempdir" EXIT

export TIMEZONE=$(</etc/timezone)
j2 cfg/$os.cfg.j2 > $tempdir/$cfg

virt-install \
	--name $name \
	--os-type=linux \
	--os-variant=$osvar \
	--ram=$ram \
	--vcpus=$cpus \
	--disk path=$basedir/images/$storage/$name.img,size=$disk \
	--location $basedir/isos/$iso \
	--network bridge:br0 \
	--graphics $graphics \
	--noautoconsole \
	$blocking \
	--initrd-inject=$tempdir/$cfg \
	--extra-args="$cfgarg hostname=$name domain=$(hostname -d) $tty"
